<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–∂–∞—Ç—å PDF –Ω–∞ iPhone</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      max-width: 500px;
      margin: 0 auto;
      background: #f5f5f7;
      color: #1d1d1f;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    button {
      background: #007aff;
      color: white;
      border: none;
      font-weight: bold;
    }
    button:disabled {
      background: #c7c7cc;
    }
    #status {
      margin-top: 10px;
      color: #6e6e73;
      font-size: 14px;
    }
    #saveBtn {
      display: none;
      background: #34c759;
    }
  </style>
</head>
<body>
  <h2>–°–∂–∞—Ç—å PDF –Ω–∞ iPhone</h2>
  <p>–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–∫–∞–Ω–æ–≤ –∏ —Ñ–æ—Ç–æ-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.</p>
  
  <input type="file" id="fileInput" accept=".pdf" />
  <button id="compressBtn" disabled>–°–∂–∞—Ç—å</button>
  <div id="status"></div>
  <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ ¬´–§–∞–π–ª—ã¬ª</button>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let compressedBlob = null;

    const fileInput = document.getElementById('fileInput');
    const compressBtn = document.getElementById('compressBtn');
    const saveBtn = document.getElementById('saveBtn');
    const statusEl = document.getElementById('status');

    fileInput.addEventListener('change', () => {
      compressBtn.disabled = !fileInput.files.length;
    });

    compressBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      try {
        statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ PDF...';
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const totalPages = pdf.numPages;

        const { jsPDF } = window.jspdf;
        let doc = null;

        for (let i = 1; i <= totalPages; i++) {
          statusEl.textContent = `–°—Ç—Ä. ${i} –∏–∑ ${totalPages}...`;

          const page = await pdf.getPage(i);
          const scale = 0.6;
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const ctx = canvas.getContext('2d');

          await page.render({ canvasContext: ctx, viewport }).promise;

          const imgData = canvas.toDataURL('image/jpeg', 0.7);
          canvas.remove();

          if (i === 1) {
            doc = new jsPDF({
              orientation: viewport.width > viewport.height ? 'l' : 'p',
              unit: 'px',
              format: [viewport.width, viewport.height]
            });
          } else {
            doc.addPage([viewport.width, viewport.height]);
          }
          doc.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height);
        }

        statusEl.textContent = '–ì–æ—Ç–æ–≤–æ!';
        compressedBlob = doc.output('blob');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        saveBtn.style.display = 'block';
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
      }
    });

    // üîë –ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –æ—Ç–∫—Ä—ã—Ç–∏–µ blob-URL –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
    saveBtn.addEventListener('click', () => {
      if (!compressedBlob) return;
      
      // –°–æ–∑–¥–∞—ë–º URL –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
      const url = URL.createObjectURL(compressedBlob);
      
      // Safari –Ω–∞ iOS —Å–æ—Ö—Ä–∞–Ω–∏—Ç PDF –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ blob-URL
      window.open(url, '_blank');
      
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      statusEl.innerHTML = '‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É –≤—ã—à–µ ‚Üí –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –§–∞–π–ª—ã¬ª';
    });
  </script>
</body>
</html>
