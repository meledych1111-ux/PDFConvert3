<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°–∂–∞—Ç—å PDF –Ω–∞ iPhone</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      max-width: 500px;
      margin: 0 auto;
      background: #f5f5f7;
      color: #1d1d1f;
    }
    .control-group {
      margin: 12px 0;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }
    input[type="range"] {
      width: 100%;
    }
    .value-display {
      text-align: right;
      color: #007aff;
      font-size: 14px;
    }
    input[type="file"], button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    button {
      background: #007aff;
      color: white;
      border: none;
      font-weight: bold;
    }
    #saveBtn {
      background: #34c759;
      display: none;
    }
    #status {
      margin-top: 10px;
      color: #6e6e73;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>–°–∂–∞—Ç—å PDF –Ω–∞ iPhone</h2>
  <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã.</p>

  <input type="file" id="fileInput" accept=".pdf" />

  <div class="control-group">
    <label for="scaleSlider">üìè –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: <span id="scaleValue">0.6</span>x</label>
    <input type="range" id="scaleSlider" min="0.3" max="1.0" step="0.05" value="0.6" />
    <div class="value-display">–º–µ–Ω—å—à–µ ‚Üí –º–µ–Ω—å—à–µ —Ñ–∞–π–ª</div>
  </div>

  <div class="control-group">
    <label for="qualitySlider">üñºÔ∏è –ö–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <span id="qualityValue">0.7</span></label>
    <input type="range" id="qualitySlider" min="0.3" max="0.95" step="0.05" value="0.7" />
    <div class="value-display">–Ω–∏–∂–µ ‚Üí —Å–∏–ª—å–Ω–µ–µ —Å–∂–∞—Ç–∏–µ</div>
  </div>

  <button id="compressBtn" disabled>–°–∂–∞—Ç—å PDF</button>
  <div id="status"></div>
  <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ ¬´–§–∞–π–ª—ã¬ª</button>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let compressedBlob = null;

    // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const fileInput = document.getElementById('fileInput');
    const compressBtn = document.getElementById('compressBtn');
    const saveBtn = document.getElementById('saveBtn');
    const statusEl = document.getElementById('status');

    const scaleSlider = document.getElementById('scaleSlider');
    const qualitySlider = document.getElementById('qualitySlider');
    const scaleValue = document.getElementById('scaleValue');
    const qualityValue = document.getElementById('qualityValue');

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    scaleSlider.addEventListener('input', () => {
      scaleValue.textContent = parseFloat(scaleSlider.value).toFixed(2);
    });
    qualitySlider.addEventListener('input', () => {
      qualityValue.textContent = parseFloat(qualitySlider.value).toFixed(2);
    });

    fileInput.addEventListener('change', () => {
      compressBtn.disabled = !fileInput.files.length;
    });

    compressBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const scale = parseFloat(scaleSlider.value);
      const quality = parseFloat(qualitySlider.value);

      try {
        statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ PDF...';
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const totalPages = pdf.numPages;

        const { jsPDF } = window.jspdf;
        let doc = null;

        for (let i = 1; i <= totalPages; i++) {
          statusEl.textContent = `–°—Ç—Ä. ${i} –∏–∑ ${totalPages}...`;

          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const ctx = canvas.getContext('2d');

          await page.render({ canvasContext: ctx, viewport }).promise;

          const imgData = canvas.toDataURL('image/jpeg', quality);
          canvas.remove();

          if (i === 1) {
            doc = new jsPDF({
              orientation: viewport.width > viewport.height ? 'l' : 'p',
              unit: 'px',
              format: [viewport.width, viewport.height]
            });
          } else {
            doc.addPage([viewport.width, viewport.height]);
          }
          doc.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height);
        }

        statusEl.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ!';
        compressedBlob = doc.output('blob');
        saveBtn.style.display = 'block';
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + (err.message || '–Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å PDF');
      }
    });

    saveBtn.addEventListener('click', () => {
      if (!compressedBlob) return;
      const url = URL.createObjectURL(compressedBlob);
      window.open(url, '_blank');
      statusEl.innerHTML = '‚úÖ –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É ‚Üí ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –§–∞–π–ª—ã¬ª';
    });
  </script>
</body>
</html>
